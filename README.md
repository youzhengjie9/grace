
## 手写微服务组件-轻量级的注册中心&配置中心(基于Nacos2.2.1)




### 所有功能需求

- **服务注册**：

    - 方案1：服务消费者(Client端)在启动后会通过netty发送注册请求的方式向Server端注册自己的服务，提供Client端自身的一些数据，比如ip地址、端口、服务名等信息。Server端接收到Client端发来的注册请求后，就会把这些数据信息存储在一个双层的内存Map中，服务端通过异步读取阻塞队列来防止同时向一个Server注册多个实例间的线程安全问题。
    - 方案2：Eureka Client会通过发送REST请求的方式，向Eureka Server注册自己的服务。注册时，提供自身的元数据，比如ip地址、端口、运行状况指标、主页地址等信息。Eureka Server接收到注册请求后，就会把这些元数据信息存储在一个双层的Map中。什么时候注册？在启动微服务的时候

- **心跳机制：**

    - 方案1：Client端在启动连接上Server端后，会通过netty的写空闲事件来发送心跳信息来持续通知Server端，说明服务一直处于可用状态，防止该实例被Server端剔除。默认5s发送一次心跳。
    - 方案2：在服务注册后，Eureka Client会维护一个心跳来持续通知Eureka Server，说明服务一直处于可用状态，防止被剔除。默认每隔30秒eureka.instance.lease-renewal-interval-in-seconds 发送一次心跳来进行服务续约。

- **服务发现**：

    - 方案1：Client在连接上服务提供者的服务时，会先发送请求给Server，获取Server内存注册表上面注册的服务清单，并且缓存在Client本地的Map中，同时会在Client本地开启一个定时任务定时拉取服务端最新的注册表信息更新到本地缓存，默认15s拉取一次。
    - 方案2：服务消费者（Eureka Client）在启动的时候，会发送一个REST请求给Eureka Server，获取注册中心的服务清单，并且缓存在客户端本地。同时，为了性能及安全性考虑，Eureka Server会每隔30秒更新一次缓存中的服务清单。

- **服务调用：**

    - 方案1：服务消费者在获取到服务清单后，可以根据清单中的服务信息，查找到该服务的地址，从而进行访问(远程调用)。
    - 方案2：通过对RestTemplate定义拦截器实现负载均衡，默认是轮询策略，可以自定义负载均衡策略

- **负载均衡策略：**

    - 提供丰富的负载均衡策略，包括：轮询、随机、LRU、LFU、一致性HASH等；

- **服务健康检查**：

    - Server通过netty的读空闲事件来检查Client注册服务实例的健康情况，对于超过5s没有收到Client端心跳的实例，会先把该实例的读空闲次数记录下来，如果长达30s都没有收到该实例的心跳，会关闭Server服务端与该Client端的链路。

- **服务同步**：

    - Server集群之间在添加实例或者剔除实例时会互相同步服务实例，用来保证服务信息的一致性，使用redis的分布式锁来解决数据覆盖的问题以及通过保证部分操作的顺序来防止数据丢失。

- **服务下线（cancel）：**

    - 方案1：当Eureka Client需要关闭或重启时，就不希望在这个时间段内再有请求进来，所以，就需要提前先发送REST请求给EurekaServer，告诉Eureka Server自己要下线了，Eureka Server在收到请求后，就会把该服务状态置为下线（DOWN），并把该下线事件传播出去。

- **失效剔除（evict）：**

    - 服务实例可能会因为网络故障等原因，导致不能提供服务，而此时该实例也没有发送请求给Eureka Server来进行服务下线。所以，还需要有服务剔除的机制。Eureka Server在启动的时候会创建一个定时任务，每隔一段时间（默认60秒），从当前服务清单中把超时没有续约（默认90秒eureka.instance.lease-expiration-duration-inseconds）的服务剔除。

- **CAP定理的P（容错性）：**

    - 服务提供方集群注册时，某个服务节点不可用时将会自动摘除，同时消费方将会移除失效节点将流量分发到其余节点，提高系统容错能力。

- **服务重连**:

    - Client在Server端宕机或者重启或者Client端因为网络问题连接不上Server集群，会自动重连，直到连接上集群上其中的一个Server。

- **Server集群服务心跳**：

    - Server集群间通过http请求来互相发送心跳，每个Server会记录着健康的Server实例，等客户端服务发现时也把健康的Server实例传给Client，以便Client所连接的Server宕机了也能连接上集群上的其他Server节点，默认5s发送一次心跳。

- **支持动态修改集群节点**:

    - 在Server集群启动后，可在不影响原本服务的使用的前提下，动态地添加或删除集群节点。

- **服务实例类型：**

    - **临时实例**：如果实例宕机超过一定时间，会从服务列表剔除，（默认）。

    - **非临时实例**：如果实例宕机，不会从服务列表剔除，也可以叫永久实例。

      配置一个服务实例为永久实例：

    - ```java
    spring:
      cloud:
       nacos:
          discovery:
            ephemeral: false # 设置为非临时实例
    ```



### v1.0版本需求 ⭐



- **服务注册**：
    - Grace Client会通过发送Http请求的方式，向Grace Server注册自己的服务。注册时，提供自身的元数据，比如ip地址、端口、运行状况指标、等信息。Grace Server接收到注册请求后，就会把这些元数据信息存储在一个双层的Map中。在Grace Client微服务启动的时候就注册。



- **服务发现**：
    - 服务消费者（Grace Client）在启动的时候，会发送一个Http请求给Grace Server，获取注册中心的服务列表，并且缓存在Grace Client本地。Grace Server会每隔15秒更新一次缓存中的服务清单。





















